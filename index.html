<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Trash Bins Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .bin-card {
            background: white; border-radius: 15px; width: 240px; padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left;
        }
        .bin-card h2 { text-align: center; margin-top: 0; }
        .status-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin: 15px 0; padding: 10px; border-radius: 8px; background: #f8f9fa;
        }
        .label { font-size: 14px; color: #666; }
        .value { font-weight: bold; font-size: 16px; }
        .text-green { color: #28a745; }
        .text-red { color: #dc3545; }
        .bg-alert { background-color: #ffeeba; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
    </style>
</head>
<body>
    <h1>üóëÔ∏è ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
    <div class="container" id="container"></div>

    <script>
        const SUPABASE_URL = 'https://ljatucqreqiazvgwjugp.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_Aoo9e4gK8_aQn1-GiKVOAA_WDf7iDS4'; 

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const container = document.getElementById('container');
        for(let i=1; i<=4; i++) {
            container.innerHTML += `
                <div class="bin-card">
                    <h2>‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}</h2>
                    <div class="status-row">
                        <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡∏≤:</span>
                        <span class="value" id="lid-${i}">...</span>
                    </div>
                    <div class="status-row" id="row-full-${i}">
                        <span class="label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞:</span>
                        <span class="value" id="full-${i}">...</span>
                    </div>
                </div>
            `;
        }

        function updateUI(id, isOpen, isFull) {
            const lidElem = document.getElementById(`lid-${id}`);
            if (isOpen) { lidElem.innerHTML = 'üëê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î'; lidElem.className = 'value text-green'; }
            else { lidElem.innerHTML = 'üîí ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà'; lidElem.className = 'value'; }

            const fullElem = document.getElementById(`full-${id}`);
            const rowFull = document.getElementById(`row-full-${id}`);
            if (isFull) { fullElem.innerHTML = '‚õî ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!'; fullElem.className = 'value text-red'; rowFull.classList.add('bg-alert'); }
            else { fullElem.innerHTML = '‚úÖ ‡∏ß‡πà‡∏≤‡∏á'; fullElem.className = 'value text-green'; rowFull.classList.remove('bg-alert'); }
        }

        async function fetchInitialData() {
            // --- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: bins -> Bins ---
            const { data } = await client.from('Bins').select('*').order('id');
            if (data) data.forEach(bin => updateUI(bin.id, bin.is_open, bin.is_full));
        }

        // --- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: bins -> Bins ---
        client.channel('schema-db-changes')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Bins' }, 
            (payload) => {
                updateUI(payload.new.id, payload.new.is_open, payload.new.is_full);
            })
            .subscribe();

        fetchInitialData();
    </script>
</body>
</html>