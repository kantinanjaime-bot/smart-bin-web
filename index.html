<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Trash Bins Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        .header-status { font-size: 18px; margin-bottom: 5px; font-weight: bold; }
        .debug-text { font-size: 12px; color: #888; margin-bottom: 20px; } /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ */
        .online { color: #28a745; }
        .offline { color: #dc3545; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .bin-card {
            background: white; border-radius: 15px; width: 240px; padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left;
            transition: opacity 0.3s;
        }
        .bin-offline { opacity: 0.6; filter: grayscale(100%); }
        
        .bin-card h2 { text-align: center; margin-top: 0; }
        .status-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin: 15px 0; padding: 10px; border-radius: 8px; background: #f8f9fa;
        }
        .label { font-size: 14px; color: #666; }
        .value { font-weight: bold; font-size: 16px; }
        .text-green { color: #28a745; }
        .text-red { color: #dc3545; }
        .bg-alert { background-color: #ffeeba; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
    </style>
</head>
<body>
    <h1>üóëÔ∏è ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
    
    <div class="header-status" id="system-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
    <div class="debug-text" id="debug-timer">‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...</div>

    <div class="container" id="container"></div>

    <script>
        const SUPABASE_URL = 'https://ljatucqreqiazvgwjugp.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_Aoo9e4gK8_aQn1-GiKVOAA_WDf7iDS4'; 

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const container = document.getElementById('container');
        
        let lastUpdateTime = 0; 

        for(let i=1; i<=4; i++) {
            container.innerHTML += `
                <div class="bin-card" id="card-${i}">
                    <h2>‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}</h2>
                    <div class="status-row">
                        <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡∏≤:</span>
                        <span class="value" id="lid-${i}">...</span>
                    </div>
                    <div class="status-row" id="row-full-${i}">
                        <span class="label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì:</span>
                        <span class="value" id="full-${i}">...</span>
                    </div>
                </div>
            `;
        }

        function updateUI(id, isOpen, isFull, timestamp) {
            if(timestamp) {
                const time = new Date(timestamp).getTime();
                // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if(time > lastUpdateTime) lastUpdateTime = time;
            }

            const lidElem = document.getElementById(`lid-${id}`);
            if (isOpen) { lidElem.innerHTML = 'üëê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î'; lidElem.className = 'value text-green'; }
            else { lidElem.innerHTML = 'üîí ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà'; lidElem.className = 'value'; }

            const fullElem = document.getElementById(`full-${id}`);
            const rowFull = document.getElementById(`row-full-${id}`);
            if (isFull) { fullElem.innerHTML = '‚õî ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!'; fullElem.className = 'value text-red'; rowFull.classList.add('bg-alert'); }
            else { fullElem.innerHTML = '‚úÖ ‡∏ß‡πà‡∏≤‡∏á'; fullElem.className = 'value text-green'; rowFull.classList.remove('bg-alert'); }
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ Online/Offline
        setInterval(() => {
            const now = new Date().getTime();
            const diffSeconds = (now - lastUpdateTime) / 1000; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            const statusDiv = document.getElementById('system-status');
            const debugDiv = document.getElementById('debug-timer');
            const cards = document.querySelectorAll('.bin-card');

            // ‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÜ ‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡πÅ‡∏•‡πâ‡∏ß
            if (lastUpdateTime > 0) {
                debugDiv.innerHTML = `‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${diffSeconds.toFixed(1)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            }

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 3.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ -> OFFLINE
            if (lastUpdateTime > 0 && diffSeconds > 3.5) {
                statusDiv.innerHTML = `üî¥ OFFLINE`; 
                statusDiv.className = 'header-status offline';
                cards.forEach(card => card.classList.add('bin-offline'));
            } else if (lastUpdateTime > 0) {
                statusDiv.innerHTML = `üü¢ ONLINE`; 
                statusDiv.className = 'header-status online';
                cards.forEach(card => card.classList.remove('bin-offline'));
            }
        }, 100); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ñ‡∏µ‡πà‡πÜ ‡∏ó‡∏∏‡∏Å 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

        async function fetchInitialData() {
            const { data } = await client.from('Bins').select('*').order('id');
            if (data) {
                data.forEach(bin => {
                    updateUI(bin.id, bin.is_open, bin.is_full, bin.last_updated);
                });
            }
        }

        client.channel('schema-db-changes')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Bins' }, 
            (payload) => {
                updateUI(payload.new.id, payload.new.is_open, payload.new.is_full, payload.new.last_updated);
            })
            .subscribe();

        fetchInitialData();
    </script>
</body>
</html>